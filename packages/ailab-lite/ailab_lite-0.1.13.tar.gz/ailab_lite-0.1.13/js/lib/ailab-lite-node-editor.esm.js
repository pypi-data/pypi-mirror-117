import e from"rete";import t from"rete-vue-render-plugin";import s from"rete-connection-plugin";import o from"rete-area-plugin";import n from"rete-history-plugin";import i from"rete-connection-mastery-plugin";import a from"rete-keyboard-plugin";import r from"rete-minimap-plugin";import l from"rete-auto-arrange-plugin";import d from"rete-vue-render-plugin/src/mixin";import{getObjectValueByPath as c}from"vuetify/lib/util/helpers";import{PerfectScrollbar as u}from"vue2-perfect-scrollbar";import h from"vue";import p from"@koumoul/vjsf";import"@koumoul/vjsf/dist/main.css";var m={props:["readonly","emitter","ikey","getData","putData","possibleValues","selectedValues"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{ikey}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-select \n            solo \n            flat\n            v-model="selectedValues" \n            :items="possibleValues" \n            @input="change($event)" \n            @dblclick.stop="" \n            @pointermove.stop=""></v-select>\n        </v-col>\n      </v-layout>',data:()=>({value:0,model:""}),methods:{change(e){this.update()},update(){this.ikey&&this.putData(this.ikey,this.model),this.emitter.trigger("process")}},mounted(){this.model=this.selectedValues,void 0!==this.getData(this.ikey)&&(this.model=this.getData(this.ikey)),this.update()}};class v extends e.Control{constructor(e,t,s,o,n){super(t),this.component=m,this.props={emitter:e,ikey:t,readonly:n,possibleValues:o,selectedValues:s}}setValue(e){this.vueContext.value=e}}const g=new e.Socket("timeseries"),f=new e.Socket("dataframe"),_=new e.Socket("Integer value"),y=new e.Socket("Number value"),b=new e.Socket("Timeseries"),k=new e.Socket("Any");g.combineWith(k),f.combineWith(k),_.combineWith(k),y.combineWith(k),b.combineWith(k),k.combineWith(k);var w={props:["emitter","ikey","getData","putData","default","node"],template:'\n    <v-layout row wrap style="width:700px; height:50px">\n        <v-col cols=3>\n        <v-combobox\n          @change=\'change\'\n          v-model="itemsChosen"\n          :items="items"\n          label="Aggregation method"\n          multiple\n          solo\n          flat\n          width="auto"\n        ></v-combobox>\n        </v-col>\n        <v-col cols=2>\n            <v-text-field \n            @change=\'change\'\n            v-model="periodLength"\n            solo \n            flat/>\n        </v-col>\n        <v-col cols=3>\n        <v-combobox\n          @change=\'change\'\n          width="auto"\n          v-model="periodChosen"\n          :items="period"\n          label="Time resolution"\n          solo \n          flat\n        ></v-combobox>\n        </v-col>\n        <v-col>\n        <v-btn small color="green" @click="add($event)" @dblclick.stop="">Add</v-btn>\n        <v-btn small color="red" @click="remove($event)" @dblclick.stop="">Delete</v-btn>\n        </v-col>\n    </v-layout>\n    ',data:()=>({value:"",title:"",items:["count","sum","mean","median","var","std","min","max","skew","kurt"],itemsChosen:[],period:["seconds","minutes","hours","days"],periodChosen:void 0,controls:[],periodLength:0}),methods:{change(e){this.update()},update(){console.log("change"),this.ikey&&this.putData(this.ikey,{itemsChosen:this.itemsChosen,periodChosen:this.periodChosen,periodLength:this.periodLength}),this.emitter.editor.trigger("process")},add(){this.emitter.add()},remove(){this.emitter.remove(this.ikey)}},mounted(){this.value=this.default,this.title=this.caption,this.update()}};class C extends e.Control{constructor(e,t){super(t),this.component=w,this.props={emitter:e,ikey:t,caption:t}}setValue(e){this.vueContext.value=e}}class x extends e.Component{constructor(){super("RollingAggregation"),this.className="RollingAggregation",this.humanModule="fathom_lib.transformers.rolling_aggregation",this.pyModule="fathom_lib.transformers.rolling_aggregation",this.controls={},this.node=void 0}builder(t){return this.node=t,t.addControl(new v(this.editor,"timestamp",null,[],!1)),t.addControl(new v(this.editor,"id",null,[],!1)),t.addInput(new e.Input("default","",k,!0)),t.addOutput(new e.Output("default","",k,!0)),this.add(),t.className=this.className,t.humanModule=this.humanModule,t.pyModule=this.pyModule,t.is_dataframe=!1,this.node}add(){var e=Object.keys(this.controls).length,t=new C(this,"aggregation"+e);this.controls[e]=t,this.node.addControl(t),this.editor.trigger("process"),this.node.update()}remove(e){this.node.controls.delete(e),this.node.update(),this.editor.trigger("process")}}var S={props:["readonly","emitter","ikey","getData","putData","default","caption"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{title}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-text-field solo flat :title="title" :value="value" @input="change($event)" :readonly="readonly" @dblclick.stop="" @pointerdown.stop="" @pointermove.stop="" ></v-text-field>\n        </v-col>\n    </v-layout>',data:()=>({value:"",title:""}),methods:{change(e){this.value=e,this.update()},update(){this.ikey&&this.putData(this.ikey,this.value),this.emitter.trigger("process")}},mounted(){this.value=this.default,this.title=this.caption,this.update()}};class N extends e.Control{constructor(e,t,s,o){super(t),this.component=S,this.props={emitter:e,ikey:t,readonly:o,default:s,caption:t}}setValue(e){this.vueContext.value=e}}class D extends e.Component{constructor(e){super("DynamicDataFrame"),this.className="DataFrame",this.humanModule="fathom_lib.datasources",this.pyModule="fathom_lib.datasources",this.name=e.name,this.schema=JSON.parse(e.schema_json)}builder(t){let s=this.schema.fields.map((e=>e.name));return t.addControl(new v(this.editor,"X_columns",s,s,!1)),t.addControl(new v(this.editor,"y_columns",[],s,!1)),t.addControl(new v(this.editor,"additional_columns",[],s,!1)),t.addOutput(new e.Output("default","",k)),t.className=this.className,t.humanModule=this.humanModule,t.pyModule=this.pyModule,t.schema_json=this.schema.fields,t.is_dataframe=!0,t}}var E={props:["readonly","emitter","ikey","getData","putData","default","caption"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{title}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-checkbox dense shaped dark  v-model="value" @input="change($event)" @dblclick.stop="" @pointermove.stop=""></v-checkbox>\n        </v-col>\n       </v-layout>',data:()=>({value:"",title:""}),methods:{change(e){this.value=e,this.update()},update(){this.ikey&&this.putData(this.ikey,this.value),this.emitter.trigger("process")}},mounted(){this.value=this.default,this.title=this.caption,this.update()}};class O extends e.Control{constructor(e,t,s,o){super(t),this.component=E,this.props={emitter:e,ikey:t,readonly:o,default:s,caption:t}}setValue(e){this.vueContext.value=e}}var M={props:["readonly","emitter","ikey","getData","putData","value"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{ikey}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-text-field type="number" step="any" solo flat :value="value" @input="change($event)" @dblclick.stop="" @pointermove.stop=""></v-text-field>\n        </v-col>\n      </v-layout>',data:()=>({}),methods:{change(e){this.value=e,this.update()},update(){this.ikey&&this.putData(this.ikey,this.value),this.emitter.trigger("process")}},mounted(){this.update()}};class j extends e.Control{constructor(e,t,s,o){super(t),this.component=M,this.props={emitter:e,ikey:t,readonly:o,value:s}}setValue(e){this.vueContext.value=e}}var $={props:["readonly","emitter","ikey","getData","putData","value"],template:'<v-layout row wrap no-gutters>\n        <v-col md="5">\n            <v-subheader dark>{{ikey}}</v-subheader>\n        </v-col>\n        <v-col>\n            <v-text-field type="number" pattern="[0-9]" step="1" solo flat :value="value" @input="change($event)" @dblclick.stop="" @pointermove.stop=""></v-text-field>\n        </v-col>\n      </v-layout>',data:()=>({}),methods:{change(e){this.value=e,this.update()},update(){this.ikey&&this.putData(this.ikey,this.value),this.emitter.trigger("process")}},mounted(){this.update()}};class R extends e.Control{constructor(e,t,s,o){super(t),this.component=$,this.props={emitter:e,ikey:t,readonly:o,value:s}}setValue(e){this.vueContext.value=e}}class A extends e.Component{constructor(e){super("DynamicComponent"),this.className=e.name,this.name=e.js_name,this.humanModule=e.human_module,this.pyModule=e.py_module,this.params=e.params,this.input_list=e.input_list,this.output_list=e.output_list}builder(t){return Object.keys(this.params).forEach((e=>{let s=this.params[e],o="float"==(n=null!=s.types[0]?s.types[0]:null)?j:"bool"==n?O:"int"==n?R:"string"==n?N:null==n?v:N;var n;o==v?t.addControl(new o(this.editor,s.name,s.default,s.choices,!1)):t.addControl(new o(this.editor,s.name,s.default,!1))})),t.addInput(new e.Input("default","",k,!0)),t.addOutput(new e.Output("default","",k,!0)),t.className=this.className,t.humanModule=this.humanModule,t.pyModule=this.pyModule,t.is_dataframe=!1,t}}function P(e,t,s,o,n,i,a,r,l,d){"boolean"!=typeof a&&(l=r,r=a,a=!1);const c="function"==typeof s?s.options:s;let u;if(e&&e.render&&(c.render=e.render,c.staticRenderFns=e.staticRenderFns,c._compiled=!0,n&&(c.functional=!0)),o&&(c._scopeId=o),i?(u=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,l(e)),e&&e._registeredComponents&&e._registeredComponents.add(i)},c._ssrRegister=u):t&&(u=a?function(e){t.call(this,d(e,this.$root.$options.shadowRoot))}:function(e){t.call(this,r(e))}),u)if(c.functional){const e=c.render;c.render=function(t,s){return u.call(s),e(t,s)}}else{const e=c.beforeCreate;c.beforeCreate=e?[].concat(e,u):[u]}return s}const X="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());function F(e){return(e,t)=>function(e,t){const s=X?t.media||"default":e,o=G[s]||(G[s]={ids:new Set,styles:[]});if(!o.ids.has(e)){o.ids.add(e);let s=t.source;if(t.map&&(s+="\n/*# sourceURL="+t.map.sources[0]+" */",s+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(t.map))))+" */"),o.element||(o.element=document.createElement("style"),o.element.type="text/css",t.media&&o.element.setAttribute("media",t.media),void 0===V&&(V=document.head||document.getElementsByTagName("head")[0]),V.appendChild(o.element)),"styleSheet"in o.element)o.styles.push(s),o.element.styleSheet.cssText=o.styles.filter(Boolean).join("\n");else{const e=o.ids.size-1,t=document.createTextNode(s),n=o.element.childNodes;n[e]&&o.element.removeChild(n[e]),n.length?o.element.insertBefore(t,n[e]):o.element.appendChild(t)}}}(e,t)}let V;const G={};const J=P({render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"node",class:e._f("kebab")([e.selected(),e.node.name,e.getNodeClass()]),attrs:{id:e.node.id}},[s("v-sheet",{staticClass:"pa-4",attrs:{color:"rgba(36, 184, 208, 0)"}},[s("div",{attrs:{id:"title-wrapper"}},[s("div",{staticClass:"left"},[s("div",{staticClass:"title"},[e._v(e._s(e.node.name)+" "),s("span",{staticClass:"progress"})])]),e._v(" "),s("div",{staticClass:"right"},["start"===e.status?s("div",[s("v-progress-circular",{attrs:{color:"white",indeterminate:""}})],1):s("div",{staticClass:"right"},[s("v-icon",{attrs:{color:e.statusColor}},[e._v("mdi-checkbox-blank-circle")])],1)])]),e._v(" "),""!==e.errorMessage?s("v-alert",{staticClass:"alertmessage",attrs:{"max-width":"300px",type:"error"}},[e._v(e._s(e.errorMessage))]):e._e()],1),e._v(" "),e._l(e.outputs(),(function(t){return s("div",{staticClass:"output"},[s("div",{staticClass:"output-title"},[e._v(e._s(t.name))]),e._v(" "),s("Socket",{directives:[{name:"socket",rawName:"v-socket:output",value:t,expression:"output",arg:"output"}],attrs:{type:"output",socket:t.socket}})],1)})),e._v(" "),e._l(e.controls(),(function(e){return s("div",{directives:[{name:"control",rawName:"v-control",value:e,expression:"control"}],staticClass:"control",staticStyle:{display:"none"}})})),e._v(" "),e._l(e.inputs(),(function(t){return s("div",{staticClass:"input"},[s("Socket",{directives:[{name:"socket",rawName:"v-socket:input",value:t,expression:"input",arg:"input"}],attrs:{type:"input",socket:t.socket}}),e._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:!t.showControl(),expression:"!input.showControl()"}],staticClass:"input-title"},[e._v(e._s(t.name))]),e._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:t.showControl(),expression:"input.showControl()"},{name:"control",rawName:"v-control",value:t.control,expression:"input.control"}],staticClass:"input-control"})],1)}))],2)},staticRenderFns:[]},undefined,{mixins:[d],props:[status],components:{Socket:P({render:function(){var e=this,t=e.$createElement;return(e._self._c||t)("div",{staticClass:"socket",class:e._f("kebab")([e.type,e.socket.name]),attrs:{title:e.socket.name}})},staticRenderFns:[]},(function(e){e&&e("data-v-0dd0170d_0",{source:".socket[data-v-0dd0170d]{display:inline-block;cursor:pointer;border:1px solid #fff;border-radius:12px;width:24px;height:24px;margin:6px;vertical-align:middle;background:#96b38a;z-index:2;box-sizing:border-box}.socket[data-v-0dd0170d]:hover{border-width:4px}.socket.multiple[data-v-0dd0170d]{border-color:#ff0}.socket.output[data-v-0dd0170d]{margin-right:-12px}.socket.input[data-v-0dd0170d]{margin-left:-12px}",map:void 0,media:void 0})}),{props:["type","socket"]},"data-v-0dd0170d",false,undefined,!1,F,void 0,void 0)},data:function(){return{status:"waiting",errorMessage:""}},computed:{statusColor:function(){return"end"===this.status?"green":"error"===this.status||"failed"==this.status?"red":"grey"}},methods:{getNodeClass:()=>"default-node-color",setStatus(e){this.status=e},setMessage(e){this.errorMessage=e}}},"data-v-fc06b154",false,undefined,!1,void 0,void 0,void 0);const T=P({render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[s("v-text-field",{attrs:{label:"Search",flat:"","hide-details":"",clearable:"","clear-icon":"mdi-close-circle-outline"},on:{"click:clear":function(t){return e.componentsInputClear()}},model:{value:e.search,callback:function(t){e.search=t},expression:"search"}}),e._v(" "),s("v-checkbox",{staticClass:"mb-5",attrs:{"hide-details":"",label:"Case sensitive"},model:{value:e.caseSensitive,callback:function(t){e.caseSensitive=t},expression:"caseSensitive"}}),e._v(" "),s("perfect-scrollbar",[s("v-treeview",{ref:"treeview",staticClass:"components-tree-view",attrs:{"item-key":"name","open-on-click":!0,items:e.items,search:e.search,filter:e.filter,open:e.open,active:e.active,activatable:"","return-object":""},on:{"update:open":function(t){e.open=t},"update:active":function(t){e.active=t}},scopedSlots:e._u([{key:"prepend",fn:function(t){return[t.item.children?s("v-icon",{domProps:{textContent:e._s("mdi-folder-network")}}):e._e()]}}])})],1)],1)},staticRenderFns:[]},(function(e){e&&e("data-v-16681e6a_0",{source:".ps{overflow:hidden!important;overflow-anchor:none;-ms-overflow-style:none;touch-action:auto;-ms-touch-action:auto}.ps__rail-x{display:none;opacity:0;transition:background-color .2s linear,opacity .2s linear;-webkit-transition:background-color .2s linear,opacity .2s linear;height:15px;bottom:0;position:absolute}.ps__rail-y{display:none;opacity:0;transition:background-color .2s linear,opacity .2s linear;-webkit-transition:background-color .2s linear,opacity .2s linear;width:15px;right:0;position:absolute}.ps--active-x>.ps__rail-x,.ps--active-y>.ps__rail-y{display:block;background-color:transparent}.ps--focus>.ps__rail-x,.ps--focus>.ps__rail-y,.ps--scrolling-x>.ps__rail-x,.ps--scrolling-y>.ps__rail-y,.ps:hover>.ps__rail-x,.ps:hover>.ps__rail-y{opacity:.6}.ps .ps__rail-x.ps--clicking,.ps .ps__rail-x:focus,.ps .ps__rail-x:hover,.ps .ps__rail-y.ps--clicking,.ps .ps__rail-y:focus,.ps .ps__rail-y:hover{background-color:#eee;opacity:.9}.ps__thumb-x{background-color:#aaa;border-radius:6px;transition:background-color .2s linear,height .2s ease-in-out;-webkit-transition:background-color .2s linear,height .2s ease-in-out;height:6px;bottom:2px;position:absolute}.ps__thumb-y{background-color:#aaa;border-radius:6px;transition:background-color .2s linear,width .2s ease-in-out;-webkit-transition:background-color .2s linear,width .2s ease-in-out;width:6px;right:2px;position:absolute}.ps__rail-x.ps--clicking .ps__thumb-x,.ps__rail-x:focus>.ps__thumb-x,.ps__rail-x:hover>.ps__thumb-x{background-color:#999;height:11px}.ps__rail-y.ps--clicking .ps__thumb-y,.ps__rail-y:focus>.ps__thumb-y,.ps__rail-y:hover>.ps__thumb-y{background-color:#999;width:11px}@supports (-ms-overflow-style:none){.ps{overflow:auto!important}}@media screen and (-ms-high-contrast:active),(-ms-high-contrast:none){.ps{overflow:auto!important}}.ps{position:relative}",map:void 0,media:void 0})}),{props:["items"],components:{PerfectScrollbar:u},methods:{componentsInputClear:function(){this.$refs.treeview.updateAll(!1)},onItemClick(e){this.$emit("itemClicked",e)}},watch:{active:function(){this.active.length>0&&(this.onItemClick(this.active[0]),this.active=[])},search:function(){this.search&&this.search.length>3?this.$refs.treeview.updateFoundNodes(!0):this.$refs.treeview.updateFoundNodes(!1)}},computed:{filter(){return this.caseSensitive?(e,t,s)=>e[s].indexOf(t)>-1:void 0}},mounted:function(){this.$refs.treeview.updateFoundNodes=e=>{let t=this.$refs.treeview.nodes,s=Object.keys(t);s=s.filter((e=>!this.$refs.treeview.excludedItems.has(e))),s.forEach((s=>this.$refs.treeview.updateOpen(c(t[s].item,this.$refs.treeview.itemKey),e))),this.$refs.treeview.emitOpen()}},data:function(){return{search:null,caseSensitive:!1,active:[],open:[]}}},undefined,false,undefined,!1,F,void 0,void 0);var L={props:["node"],components:{NodeControlPanelForm:P({render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("v-card",{staticClass:"pa-3"},[s("v-form",{ref:"form",model:{value:e.valid,callback:function(t){e.valid=t},expression:"valid"}},[s("v-jsf",{attrs:{schema:e.vjsfSchema,options:e.options},on:{change:e.changeForm},model:{value:e.controls,callback:function(t){e.controls=t},expression:"controls"}},[e._l(e.errorMessagesDict,(function(t,o){return s("template",{slot:o+"-after"},[s("span",{key:o,style:{color:e.$vuetify.theme.themes.light.fathomRed}},[e._v(e._s(e.errorMessagesDict[o]))])])}))],2)],1)],1)},staticRenderFns:[]},undefined,{extends:P({render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("v-card",[s("v-card-title",[e._v(e._s(e.formName))]),e._v(" "),s("v-card-text",[s("v-container",{attrs:{fluid:""}},[e.errorMessages?s("v-card",{staticClass:"errors",style:{color:e.$vuetify.theme.themes.light.fathomWhite},attrs:{color:"fathomRed",type:"error"}},[s("v-card-title",[e._v(" Validation errors ")]),e._v(" "),s("v-card-subtitle",{style:{color:e.$vuetify.theme.themes.light.fathomWhite}},[e._v("\n          See details below\n        ")])],1):e._e(),e._v(" "),s("v-form",{ref:"form",model:{value:e.valid,callback:function(t){e.valid=t},expression:"valid"}},[s("v-jsf",{attrs:{schema:e.vjsfSchema,options:e.options},model:{value:e.model,callback:function(t){e.model=t},expression:"model"}},[e._l(e.errorMessagesDict,(function(t,o){return s("template",{slot:o+"-after"},[s("span",{key:o,style:{color:e.$vuetify.theme.themes.light.fathomRed}},[e._v(e._s(e.errorMessagesDict[o]))])])}))],2)],1)],1)],1),e._v(" "),s("v-card-actions",[s("v-spacer"),e._v(" "),s("v-btn",{attrs:{color:"primary",text:""},on:{click:e.cancel}},[e._v("Close")]),e._v(" "),s("v-btn",{attrs:{color:"primary",text:""},on:{click:e.save}},[e._v("Save")])],1)],1)},staticRenderFns:[]},undefined,h.extend({props:["id","formName","schema","url","order"],created(){this.initData()},mounted(){},data:()=>({model:{},valid:!1,dialog:!1,errorMessages:"",errorMessagesDict:{},options:{tooltipProps:{left:!0,openOnHover:!0,openOnClick:!1}}}),watch:{id(e){this.initData()}},computed:{vjsfSchema(){return this.orderedSchema(this.schema.vuetify_json_schema)},properties(){return this.schema.vuetify_json_schema.properties},retrieveUrl(){return this.schema.retrieve_url.replace("%(pk)s",this.id)},orderedProperties(){return function(e,t){if(!Array.isArray(t))return e;const s=e=>e.reduce(((e,t)=>(e[t]=!0,e)),{}),o=s(e),n=t.filter((e=>"*"===e||o[e])),i=s(n),a=e.filter((e=>!i[e])),r=n.indexOf("*");if(-1===r){if(a.length)throw new Error("uiSchema order list does not contain "+((l=a).length>1?`properties '${l.join("', '")}'`:`property '${l[0]}'`));return n}var l;if(r!==n.lastIndexOf("*"))throw new Error("uiSchema order list contains more than one wildcard item");const d=[...n];return d.splice(r,1,...a),d}(Object.keys(this.properties),this.order)}},methods:{orderedSchema(e){if(!this.order)return e;const{orderedProperties:t}=this,s=JSON.parse(JSON.stringify(e));return s.properties={},t.map((t=>(s.properties[t]={},Object.assign(s.properties[t],e.properties[t]),null))),s},initData(){this.model={}},cancel(){this.$emit("closeDialog")},save(){this.errorMessagesDict={},this.$refs.form.validate(),this.valid}},components:{VJsf:p}}),"data-v-6bb78746",false,undefined,!1,void 0,void 0,void 0),props:["node","controls"],methods:{changeForm(){this.$emit("controlDataChange",this.controls)}},computed:{vjsfSchema(){return this.orderedSchema(this.schema)},properties(){return this.schema.properties}}},undefined,false,undefined,!1,void 0,void 0,void 0)},data:()=>({showPreview:!1,dataset:null,tab:null,items:[],headers:[],datasets:[],showSelectedColumns:!0}),computed:{show(){return null!=this.node},name(){return this.node?.name},schema(){return this.node?.schema},doc(){return this.node?.doc},controls(){return this.prepareControlData(this.node?.node)},order(){return this.node?.order},isDataframe:()=>!1},watch:{isDataframe(e,t){},dataset(e,t){},showSelectedColumns(e){this.prepareHeaders()},tab(){this.prepareHeaders()}},methods:{closeClick(){this.$emit("closePanel"),this.tab=null},onControlDataChange(e){const t=t=>!Object.prototype.hasOwnProperty.call(e,t)&&("RollingAggregation"!==this.node.name||["timestamp","id"].includes(t));Object.keys(this.node.node.data).forEach((s=>{t(s)&&(e[s]=null)})),Object.keys(e).forEach((t=>{Array.isArray(e[t])&&t.startsWith("aggregation")?Array.from(e[t]).forEach(((e,s)=>{s+=1,this.node.node.data[t+s]=e})):this.node.node.data[t]=e[t]})),this.node.node.update()},prepareControlData(e){const t={};return e.controls.forEach(((s,o,n)=>{o.startsWith("aggregation")?t.aggregation=Array.isArray(t.aggregation)?t.aggregation.concat([e.data[o]]):[e.data[o]]:t[o]=e.data[o]})),t},prepareHeaders(){0!==this.items.length&&(this.headers=[...new Set(this.items.flatMap((e=>Object.keys(e))))].map((e=>({text:e,value:e}))),this.showSelectedColumns&&(this.headers=this.headers.filter((e=>[...this.node.node.data.X_columns,...this.node.node.data.y_columns,...this.node.node.data.additional_columns].includes(e.value)))))},clearPreview(){this.showPreview=!1,this.dataset=null,["items","headers"].forEach((e=>{this[e]=[]}))}}};const I=P({render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("v-container",{staticStyle:{padding:"0"},attrs:{"no-gutters":""}},[s("link",{attrs:{href:"https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900",rel:"stylesheet"}}),e._v(" "),s("link",{attrs:{href:"https://cdn.jsdelivr.net/npm/@mdi/font@5.8.55/css/materialdesignicons.min.css",rel:"stylesheet"}}),e._v(" "),s("v-row",{attrs:{"no-gutters":""}},[s("v-col",{attrs:{cols:"12"}},[s("v-snackbar",{attrs:{color:e.snackbarData.color,top:"",timeout:"3000",absolute:""},scopedSlots:e._u([{key:"action",fn:function(t){var o=t.attrs;return[s("v-btn",e._b({attrs:{dark:"",text:""},on:{click:function(t){e.snackbarData.show=!1}}},"v-btn",o,!1),[e._v("\n            Close\n          ")])]}}]),model:{value:e.snackbarData.show,callback:function(t){e.$set(e.snackbarData,"show",t)},expression:"snackbarData.show"}},[e._v("\n        "+e._s(e.snackbarData.message)+"\n        ")]),e._v(" "),s("v-toolbar",{attrs:{dark:""}},[e.componentsOnGraph?s("v-btn",{staticClass:"primary mr-3",attrs:{disabled:e.saving,loading:e.saving,small:""},on:{click:function(t){return e.saveWorkflowClick()}}},[e._v("\n          Save\n          "),s("v-icon",{attrs:{right:""}},[e._v("mdi-content-save")])],1):e._e(),e._v(" "),e.componentsOnGraph?s("v-btn",{staticClass:"primary mr-3",attrs:{disabled:e.validating,loading:e.validating,small:""},on:{click:function(t){return e.validateGraph()}}},[e._v("\n          Validate\n          "),s("v-icon",{attrs:{right:""}},[e._v("mdi-list-status")])],1):e._e(),e._v(" "),e.validationSuccess?s("v-btn",{staticClass:"primary mr-3",attrs:{disabled:e.running,loading:e.running,small:""},on:{click:function(t){return e.runWorkflowClick()}}},[e._v("\n          Run\n          "),s("v-icon",{attrs:{right:""}},[e._v("mdi-run-fast")])],1):e._e(),e._v(" "),e.componentsOnGraph?s("v-btn",{staticClass:"primary mr-3",attrs:{small:""},on:{click:function(t){return e.fitGraphToScreen()}}},[e._v("\n          Fit to screen\n          "),s("v-icon",{attrs:{right:""}},[e._v("mdi-arrow-all")])],1):e._e(),e._v(" "),e.componentsOnGraph?s("v-btn",{staticClass:"primary mr-3",attrs:{small:""},on:{click:function(t){return e.autoArrangeGraph()}}},[e._v("\n          Autoarrange\n          "),s("v-icon",{attrs:{right:""}},[e._v("mdi-collage")])],1):e._e(),e._v(" "),e.componentsOnGraph?s("v-btn",{staticClass:"primary mr-3",attrs:{small:""},on:{click:function(t){return e.clearGraph()}}},[e._v("\n          Clear\n          "),s("v-icon",{attrs:{right:""}},[e._v("mdi-close")])],1):e._e()],1)],1)],1),e._v(" "),s("v-row",{staticStyle:{"margin-top":"0"},attrs:{"no-gutters":""}},[s("v-col",{staticClass:"left-control-panel-wrapper",attrs:{cols:"3"}},[s("v-expansion-panels",{attrs:{accordion:"",focusable:""},model:{value:e.leftPanel,callback:function(t){e.leftPanel=t},expression:"leftPanel"}},[s("v-expansion-panel",[s("v-expansion-panel-header",[e._v("\n            Datasets\n          ")]),e._v(" "),s("v-expansion-panel-content",[s("NodeComponents",{attrs:{items:e.dataframeComponents},on:{itemClicked:e.onTreeViewComponentClicked}})],1)],1),e._v(" "),s("v-expansion-panel",[s("v-expansion-panel-header",[e._v("\n            Components\n          ")]),e._v(" "),s("v-expansion-panel-content",[s("NodeComponents",{attrs:{items:e.nodeComponents},on:{itemClicked:e.onTreeViewComponentClicked}})],1)],1)],1)],1),e._v(" "),s("v-col",{staticClass:"node-editor-wrapper",attrs:{cols:"9"}},[s("div",{staticClass:"node-editor",attrs:{id:"rete"}}),e._v(" "),s("NodeControlPanel",{attrs:{node:e.selectedNode},on:{closePanel:e.onClosePanel}})],1)],1)],1)},staticRenderFns:[]},undefined,{name:"app",props:{datasets:Array,componentSchemas:Array,widget_:Object,workflow:String,vuetify:Object},components:{NodeComponents:T,NodeControlPanel:P({render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("v-col",{directives:[{name:"show",rawName:"v-show",value:e.show,expression:"show"}],staticClass:"node-control-panel",attrs:{cols:"4"}},[s("v-card",{staticClass:"card"},[s("perfect-scrollbar",[s("v-sheet",{staticClass:"pa-4 grey",class:{"lighten-2":!e.$vuetify.theme.dark,"darken-2":e.$vuetify.theme.dark}},[s("div",[e._v("\n          "+e._s(e.name)+"\n          "),s("v-icon",{staticClass:"float-right",on:{click:function(t){return e.closeClick()}}},[e._v(" mdi-close-circle-outline ")])],1)]),e._v(" "),s("v-card-text",[s("v-tabs",{attrs:{"background-color":"accent-4",centered:""},model:{value:e.tab,callback:function(t){e.tab=t},expression:"tab"}},[s("v-tab",{attrs:{href:"#node-controls"}},[e._v(" Controls ")]),e._v(" "),e.doc?s("v-tab",{attrs:{href:"#node-docs"}},[e._v(" Documentation ")]):e._e(),e._v(" "),e.isDataframe?s("v-tab",{attrs:{href:"#node-dataset-preview"}},[e._v(" Dataset preview ")]):e._e(),e._v(" "),s("v-tab-item",{attrs:{value:"node-controls"}},[e.schema?s("NodeControlPanelForm",{attrs:{controls:e.controls,schema:e.schema,order:e.order},on:{controlDataChange:e.onControlDataChange}}):e._e()],1),e._v(" "),e.doc?s("v-tab-item",{attrs:{value:"node-docs"}},[s("div",[s("pre",{staticStyle:{"white-space":"pre-wrap",color:"white"},domProps:{innerHTML:e._s(e.doc)}})])]):e._e(),e._v(" "),e.isDataframe?s("v-tab-item",{attrs:{value:"node-dataset-preview"}},[s("v-switch",{attrs:{label:"Show selected columns"},model:{value:e.showSelectedColumns,callback:function(t){e.showSelectedColumns=t},expression:"showSelectedColumns"}}),e._v(" "),s("v-select",{attrs:{label:"Dataset",items:e.datasets,clearable:""},model:{value:e.dataset,callback:function(t){e.dataset=t},expression:"dataset"}}),e._v(" "),e.showPreview?s("v-data-table",{staticClass:"elevation-1",attrs:{headers:e.headers,items:e.items,"items-per-page":5}}):e._e()],1):e._e()],1)],1)],1)],1)],1)},staticRenderFns:[]},(function(e){e&&e("data-v-8da0844a_0",{source:".ps{overflow:hidden!important;overflow-anchor:none;-ms-overflow-style:none;touch-action:auto;-ms-touch-action:auto}.ps__rail-x{display:none;opacity:0;transition:background-color .2s linear,opacity .2s linear;-webkit-transition:background-color .2s linear,opacity .2s linear;height:15px;bottom:0;position:absolute}.ps__rail-y{display:none;opacity:0;transition:background-color .2s linear,opacity .2s linear;-webkit-transition:background-color .2s linear,opacity .2s linear;width:15px;right:0;position:absolute}.ps--active-x>.ps__rail-x,.ps--active-y>.ps__rail-y{display:block;background-color:transparent}.ps--focus>.ps__rail-x,.ps--focus>.ps__rail-y,.ps--scrolling-x>.ps__rail-x,.ps--scrolling-y>.ps__rail-y,.ps:hover>.ps__rail-x,.ps:hover>.ps__rail-y{opacity:.6}.ps .ps__rail-x.ps--clicking,.ps .ps__rail-x:focus,.ps .ps__rail-x:hover,.ps .ps__rail-y.ps--clicking,.ps .ps__rail-y:focus,.ps .ps__rail-y:hover{background-color:#eee;opacity:.9}.ps__thumb-x{background-color:#aaa;border-radius:6px;transition:background-color .2s linear,height .2s ease-in-out;-webkit-transition:background-color .2s linear,height .2s ease-in-out;height:6px;bottom:2px;position:absolute}.ps__thumb-y{background-color:#aaa;border-radius:6px;transition:background-color .2s linear,width .2s ease-in-out;-webkit-transition:background-color .2s linear,width .2s ease-in-out;width:6px;right:2px;position:absolute}.ps__rail-x.ps--clicking .ps__thumb-x,.ps__rail-x:focus>.ps__thumb-x,.ps__rail-x:hover>.ps__thumb-x{background-color:#999;height:11px}.ps__rail-y.ps--clicking .ps__thumb-y,.ps__rail-y:focus>.ps__thumb-y,.ps__rail-y:hover>.ps__thumb-y{background-color:#999;width:11px}@supports (-ms-overflow-style:none){.ps{overflow:auto!important}}@media screen and (-ms-high-contrast:active),(-ms-high-contrast:none){.ps{overflow:auto!important}}.ps{position:relative}",map:void 0,media:void 0})}),L,undefined,false,undefined,!1,F,void 0,void 0)},data:function(){return{editor:null,engine:null,nodeComponents:[],dataframeComponents:[],selectedNode:null,messages:[""],leftPanel:0,nodeStartX:null,nodeStartY:null,validationSuccess:!1,isMounted:!1,validating:!1,running:!1,saving:!1,snackbarData:{show:!1,color:null,message:null}}},async mounted(){if(this.initReteEditor(),this.registerComponents(this.componentSchemas,A,this.nodeComponents),this.datasets.length>0&&this.initDatasets(),this.editor.addNode(await this.editor.components.get("RollingAggregation").createNode()),this.editor.clear(),this.initReteEditorEvents(),this.workflow){let e=JSON.parse(this.workflow);this.importGraph(e.rete,JSON.parse(JSON.stringify(e.rete))).then((()=>{this.autoArrangeGraph()}))}this.widget_.model.on("change:validating",this.validating_change,this.widget_),this.widget_.model.on("change:running",this.running_change,this.widget_),this.widget_.model.on("change:validation_log",this.validation_log_change,this.widget_),this.widget_.model.on("change:saving",this.save_change,this.widget_),this.widget_.model.on("change:workflow_definition",this.workflow_definition_change,this.widget_),this.isMounted=!0},methods:{setSnackbar:function(e){this.snackbarData=e},save_change:function(){this.saving=this.widget_.model.get("saving"),this.saving||this.setSnackbar({show:!0,color:"success",message:"Workflow saved"})},workflow_definition_change:function(){let e=JSON.parse(this.widget_.model.get("workflow_definition"));this.importGraph(e.rete,JSON.parse(JSON.stringify(e.rete))).then((()=>{}))},running_change:function(){this.running=this.widget_.model.get("running"),this.running||this.setSnackbar({show:!0,color:"success",message:"Run completed. Check results below node editor"})},validating_change:function(){this.validating=this.widget_.model.get("validating")},validation_log_change:function(){const e=[],t=e=>this.editor.nodes.find((t=>t.id===parseInt(e,10))),s=t=>{t&&e.push(t)},o=o=>{const n=(i="node_id",o.reduce(((e,t)=>((e[t[i]]=e[t[i]]||[]).push(t),e)),{}));var i;Object.keys(n).map((e=>{const o=n[e][n[e].length-1];null!==o.node_id&&(((e,t="pending",s="")=>{e.vueContext.status=t,e.vueContext.errorMessage=s||""})(t(o.node_id),o.status,o.error),s(o.error),40===o.severity&&this.setSnackbar({show:!0,color:"error",message:"Something went wrong"})),null===o.node_id&&50===o.severity&&(s(o.error),this.setSnackbar({show:!0,color:"error",message:"Something went wrong"}))})),0===e.length&&(this.validationSuccess=!0,this.setSnackbar({show:!0,color:"success",message:"Validation completed"})),this.widget_.model.set("validation_log",""),this.widget_.touch()};this.widget_.model.get("validation_log").length>0&&o(JSON.parse(this.widget_.model.get("validation_log")))},initDatasets:function(){this.registerComponents(this.datasets,D,this.dataframeComponents)},initReteEditor:function(){this.allocatePath;var d=document.querySelector("#rete");const c=document.createElement("div");c.classList="background",this.editor=new e.NodeEditor("demo@0.1.0",d),this.editor.use(s);let u=this.vuetify;this.editor.use(t,{component:J,options:{vuetify:u}}),this.editor.use(a),this.editor.use(o,{background:c}),this.editor.use(n),this.editor.use(i),this.editor.use(r),this.editor.use(l,{margin:{x:50,y:50},depth:0}),this.engine=new e.Engine("demo@0.1.0"),this.engine},initReteEditorEvents:function(){this.editor.on(["process","nodecreated","noderemoved","connectioncreated","connectionremoved"],(async e=>{this.editor.silent||(await this.engine.abort(),await this.engine.process(this.editor.toJSON()))})),this.editor.on(["nodecreated","noderemoved"],(e=>{this.nodeClickHandlers()})),this.editor.on("noderemoved",(e=>{this.selectedNode&&e==this.selectedNode.node&&this.onClosePanel()})),this.editor.on("connectioncreated",(e=>{this.onConnectionCreated(e)})),this.editor.on("connectionremoved",(e=>{this.onConnectionRemoved(e)})),this.editor.on("zoom",(({source:e})=>"dblclick"!==e)),this.editor.view.resize(),o.zoomAt(this.editor),this.editor.trigger("process")},findComponentSchema:function(e){if(e.is_dataframe)return function(e){let t={name:e.name,doc:null,json_schema_form:{type:"object",properties:{X_columns:{title:"X columns",type:"array",items:{type:"string"},"x-props":{"small-chips":!0}},y_columns:{title:"Y columns",type:"array",items:{type:"string"},"x-props":{"small-chips":!0}},additional_columns:{title:"Additional columns",type:"array",items:{type:"string"},"x-props":{"small-chips":!0}}}}};if(e.schema_json){let s=e.schema_json.map((e=>e.name));Object.keys(t.json_schema_form.properties).forEach((e=>{t.json_schema_form.properties[e].items.enum=s}))}return t}(e);{let t=this.componentSchemas.find((t=>t.js_name===e.name));return t||null}},importGraph:function(e,t){return this.editor.fromJSON(e).then((()=>{Object.keys(t.nodes).forEach((e=>{var s=this.editor.nodes.find((s=>s.id===t.nodes[e].id));for(let o in t.nodes[e].data)s.data[o]=t.nodes[e].data[o];s.update()}))}))},exportGraph:function(e){const t={},s={};var o=this.editor.toJSON(),n=JSON.parse(JSON.stringify(o));Object.keys(n.nodes).map((e=>{const o=n.nodes[e];var i=this.editor.nodes.find((t=>t.id===n.nodes[e].id));if(s[e]={name:i.className,parameters:o.data,module:i.pyModule},t[e]=o,i.is_dataframe&&(s[e].schema_json={fields:i.schema_json},s[e].data_columns=s[e].parameters,s[e].parameters={},s[e].file_name=i.name),s[e].parameters.hasOwnProperty("X_columns")&&(s[e].data_columns={X_columns:s[e].parameters.X_columns},delete s[e].parameters.X_columns),"RollingAggregation"==s[e].name){let t=["timestamp","id"];s[e].data_mapping={},t.forEach((t=>{s[e].parameters.hasOwnProperty(t)&&(s[e].data_mapping[t]=s[e].parameters[t],delete s[e].parameters[t])}))}}));var i=[];return Object.keys(n.nodes).forEach((e=>{const s=n.nodes[e],o=t[e];Object.keys(s.outputs).forEach((e=>{s.outputs[e].connections.forEach((s=>{const n=s.node,a=(s.data,o.outputs[e]),r=t[n].inputs[s.input];a.connections.forEach((e=>{r.connections.forEach((t=>{i.push([t.node,t.output,e.node,e.input])}))}))}))}))})),{nodes:s,edges:i,rete:o}},clearGraph:function(){this.editor.clear()},fitGraphToScreen:function(){this.editor.view.resize(),o.zoomAt(this.editor)},autoArrangeGraph:function(){this.editor.trigger("arrange"),this.fitGraphToScreen()},resetStatuses:function(){this.editor.nodes.forEach((e=>{e.vueContext.status="pending",e.vueContext.errorMessage=""}))},startStatuses:function(){this.editor.nodes.forEach((e=>{e.vueContext.status="start",e.vueContext.errorMessage=""}))},clear:function(e){for(var t=document.getElementById("messages"),s=t.lastElementChild;s;)t.removeChild(s),s=t.lastElementChild;this.resetStatuses()},addComponentToTreeView:function(e,t,s=[],o=[]){let n=o;for(let e of s){let t=n.find((t=>t.name===e));t||(t={name:e,children:[]},n.push(t)),n=t.children||(t.children=[])}n.push({name:e,onClick:t})},registerComponents:function(e=[],t,s=[]){let o=this.allocatePath;e.forEach((e=>{let n="RollingAggregation"==e.name?new x(e):new t(e);this.editor.register(n),this.engine.register(n),this.addComponentToTreeView(n.name,(async()=>{this.editor.addNode(await n.createNode())}),t!=D?o(n):[],s)}))},onTreeViewComponentClicked:function(e){e.onClick&&e.onClick()},allocatePath:function(e){return void 0===e.humanModule?["Other"]:e.humanModule.split(".")},onConnectionCreated:function(e){if("DataFrame"==e.output.node.className){let t=this.editor.nodes.find((e=>"DataFrame"==e.className)).data.X_columns,s=e.input.node;s.controls.get("X_columns")||s.addControl(new v(this.editor,"X_columns",s.data.X_columns,t,!1))}let t=document.getElementsByClassName("connection");Array.from(t).forEach((e=>{e.parentElement.style.width="100%",e.parentElement.style.height="100%"}))},onConnectionRemoved:function(e){if("DataFrame"==e.output.node.className){let t=e.input.node;t.controls.get("X_columns")&&(t.removeControl(t.controls.get("X_columns")),delete t.data.X_columns)}},onNodeClicked:function(e){this.selectedNode=null;let t=["y_columns","time_column","X_columns","timestamp","id"],s=["time_column","timestamp","id"];var o=this.findComponentSchema(e);if(this.editor.selected.contains(e)&&o){let n=JSON.parse(JSON.stringify(o.json_schema_form)),i=this.editor.nodes.find((e=>"DataFrame"==e.className));this.selectedNode={},this.selectedNode.name=e.name,this.selectedNode.node=e,this.selectedNode.doc=o.doc?o.doc:null,"DataFrame"!=e.className&&t.forEach((t=>{if(e.controls.get(t)){let o=[];i&&(o=i.data[s.includes(t)?"additional_columns":t]),function(e,t,s,o=!0){e[t]={type:o?"array":"string",title:t,enum:s,items:{type:"string",enum:s}},o?delete e[t].enum:delete e[t].items}(n.properties,t,o,!s.includes(t)),"y_columns"!=t||e.data.y_columns||(e.data.y_columns=[]),"X_columns"==t&&(this.selectedNode.order=["X_columns","*"],n.properties.X_columns["x-slots"]={after:"<hr class='v-divider mb-2' />"},e.data.X_columns||(e.data.X_columns=o)),s.includes(t)?e.data[t]=o.includes(e.data[t])?e.data[t]:null:e.data[t]=e.data[t].filter((e=>o.includes(e)))}})),this.selectedNode.schema=n}},onClosePanel:function(){this.editor.selected.list=[],this.selectedNode=null},nodeMouseDownEvent:function(e){this.nodeStartX=e.pageX,this.nodeStartY=e.pageY},nodeMouseUpEvent:function(e){const t=Math.abs(e.pageX-this.nodeStartX),s=Math.abs(e.pageY-this.nodeStartY);let o=e.target.closest(".node");t<6&&s<6&&this.onNodeClicked(this.editor.nodes.find((e=>e.id==o.id)))},editorBackgroundClickEvent:function(e){this.selectedNode&&(this.editor.selected.list=[],this.selectedNode=null)},nodeClickHandlers:function(){let e=document.getElementsByClassName("node"),t=document.querySelector(".rete-background");t.removeEventListener("click",this.editorBackgroundClickEvent),Array.from(e).forEach((e=>{e.removeEventListener("mousedown",this.nodeMouseDownEvent),e.removeEventListener("mouseup",this.nodeMouseUpEvent)})),t.addEventListener("click",this.editorBackgroundClickEvent),Array.from(e).forEach((e=>{e.addEventListener("mousedown",this.nodeMouseDownEvent),e.addEventListener("mouseup",this.nodeMouseUpEvent)}))},atLeastComponent(e){return this.editor.nodes.filter(e).length>0},validateGraph(){let e=this.exportGraph();this.widget_.model.set("workflow_definition",JSON.stringify(e)),this.widget_.touch(),this.validating=!0,this.validationSuccess=!1,this.widget_.model.set("validating",!0),this.widget_.touch(),this.resetStatuses(),this.startStatuses()},runWorkflowClick(){let e=this.exportGraph();this.widget_.model.set("workflow_definition",JSON.stringify(e)),this.widget_.touch(),this.running=!0,this.widget_.model.set("running",!0),this.widget_.touch()},saveWorkflowClick(){let e=this.exportGraph();this.widget_.model.set("workflow_definition",JSON.stringify(e)),this.widget_.touch(),this.saving=!0,this.widget_.model.set("saving",!0),this.widget_.touch()}},computed:{componentsOnGraph(){const e=()=>!(!this.atLeastComponent((e=>["DataFrame"].includes(e.className)?e:null))||!this.atLeastComponent((e=>["DataFrame"].includes(e.className)?null:e)));return!!this.isMounted&&e()}}},undefined,false,undefined,!1,void 0,void 0,void 0),W=function(e){W.installed||(W.installed=!0,e.component("NodeEditor",I))};I.install=W;export default I;
