---
output:
  html_document:
    toc: true
    self_contained: yes
version: 0.1.1
author: Tamas Ryszard Sztanka-Toth, Nikolaos Karaiskos
email: tamasryszard.sztanka-toth@mdc-berlin.de, nikolaos.karaiskos@mdc.berlin.de
license: GPL
---

```{r knitr_options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  autodep = TRUE,
  message = FALSE,
  warning = FALSE,
  comment = NA
)
```

```{r libraries, include = F, cache=F}
library(tidyverse)
library(yaml)
library(knitr)
library(magrittr)
library(kableExtra)
library(cowplot)

theme_set(theme_cowplot(12))

cpalette <- list('orange' = '#D55E00', 'blue' = '#0072B2', 'green' = '#009E73', 'black' = '#000000', 'yellow' = '#F0E442', 
				 'grey' = '#999999', 'light_orange' = "#E69F00", 'light_blue' = "#56B4E9")

clrs = c('umis'=cpalette$light_orange, 'genes' = cpalette$light_blue,
         'reads'=cpalette$green, 'pcr'=cpalette$pink, 'pct_counts_mt'= 'black')

source(snakemake@params$r_shared_scripts)
```

```{r save_snakemake_object, echo = F}
#write_rds(snakemake, '/data/local/rajewsky/home/tsztank/projects/spatial/repos/sts-paper/fig_3_slideseq.rds')
#snakemake <- read_rds('/data/local/rajewsky/home/tsztank/projects/spatial/repos/sts-paper/fig_3_slideseq.rds')
```

```{r read_data, echo = F}
obs_df <- read_table2(snakemake@input$obs_df) %>%
    mutate(pct_counts_mt = as.double(pct_counts_mt))
var_df <- read_table2(snakemake@input$var_df)

n_beads = nrow(obs_df)
data_empty <- n_beads == 0
```

### Overview

```{r create_overview_table, echo = F, eval = F}
parameter_stats <- parameter_stats %>%
    rbind(c('UMI filter', snakemake@wildcards$umi_cutoff),
          c('# genes in data', nrow(var_df)),
          c('# of beads in data', nrow(obs_df)),
          c('median UMI', median(obs_df$total_counts)),
          c('median genes', median(obs_df$n_genes)))

parameter_stats %>%
    kbl(col.names=NULL) %>%
    kable_classic_2(full_width=F) %>%
    pack_rows('Sample info', 1, 7) %>%
    pack_rows('Data info', 8, 12)
```

### Histogram of metrics over beads

```{r data_empty, echo = F, eval = data_empty, results='asis'}
cat('This dataset has 0 beads passing the filters')
```

```{r plot_histogram_of_metrics, echo = F, fig.width=10, eval=!data_empty}
pl1 <- obs_df %>%
    select(cell_bc, total_counts, n_genes) %>%
    dplyr::rename(umis=total_counts,
                  genes=n_genes) %>%
    gather('obs', 'value', -cell_bc) %>%
    ggplot(aes(value, fill=obs)) +
        geom_histogram(bins=100) +
        scale_fill_manual(values=clrs) +
        facet_wrap(~obs, ncol=2, scales='free')

if (nrow(obs_df) > 50){
    pl1 <- pl1 +
        scale_x_log10() +
        annotation_logticks(sides='b') +
        labs(x='log(value)', y='count')
} else {
    pl1 <- pl1 +
        labs(x ='value', y='count')
}

pl2 <- obs_df %>%
    select(cell_bc, pct_counts_mt) %>%
    gather('obs', 'value', -cell_bc) %>%
    ggplot(aes(value, fill=obs)) +
        geom_histogram(bins=100) +
        scale_fill_manual(values=clrs) +
        facet_wrap(~obs, ncol=2, scales='free')+
        labs(x='value', y='count')

plot_grid(pl1,
          plot_grid(pl2, NULL, ncol=2, rel_widths=c(1.5,1), labels=""),
          ncol=1, rel_heights=c(1,1), labels="")
```


```{r check_completeness, echo = F, fig.size=10, fig.width=10}
obs_df <- obs_df %>%
    gather('res', 'cluster', starts_with('leiden'))

data_complete = F

if ('cluster' %in% colnames(obs_df)){
    data_complete = T
}

fig_height=6
fig_width=6
```

```{r incompleteness_warning, eval=!data_complete, echo=F, results='asis'}
cat('### WARNING: data incomplete\n\n')
cat(paste0('This dataset has ', n_beads, ' cells passing the filter of ', snakemake@wildcards$umi_cutoff, ' and ', nrow(var_df), ' genes.\n\n'))
cat(paste0('This dataset is too small, so it couldn\'t be properly clustered and analysed automatically'))
```


```{r umap_text, eval=data_complete, echo =F, results='asis'}
cat('### UMAP plots using different resolutions {.tabset}\n\n')
```


```{r plot_umi_umap, eval=data_complete, echo=F}
obs_df <- obs_df %>%
    mutate(cluster = factor(cluster)) %>%
    mutate(log1p_total_counts = log2(1+total_counts))

obs_colnames <- colnames(obs_df)

# barcode file attached at the python level
barcode_file <- 'x_pos' %in% obs_colnames && 'y_pos' %in% obs_colnames

if (barcode_file){
        obs_df %>%
            filter(res == 'leiden_1') %>%
            arrange(total_counts) %>%
            mutate(total_counts = ifelse(total_counts > 1000, 1000, total_counts)) %>%
            ggplot(aes(x_pos, y_pos, color = total_counts)) +
                geom_point(size = as.numeric(snakemake@params$downstream_variables$plot_bead_size))+
                coord_fixed()+
                scale_color_viridis_c(option =  "magma", limits = c(0, 1100),  breaks = c(100, 300, 500, 700, 900)) +
                #scale_color_viridis_c(option =  "magma", limits = c(0, 70000),  breaks = c(10000, 20000, 30000, 40000, 50000, 60000)) +
                guides(color = guide_colorbar(barheight = 15)) + 
                labs(color='UMI count', y='', x='') + 
                theme(panel.background = element_rect(fill = 'gray90'),
                    axis.text = element_blank(), axis.ticks = element_blank())
    }

# gene plotting function
plot_genes <- function(genes){
    gene_expr <- expr_df %>%
        filter(gene %in% genes)

    gene_expr <- obs_df %>%
        filter(res == 'leiden_0.2') %>%
        left_join(gene_expr, by = 'cell_bc') %>%
        # fill empty values
        # first spread the genes, so each gene is a column
        # then create long df and replace NA with 0
        spread(gene, expr) %>%
        gather('gene', 'expr', all_of(genes)) %>%
        replace_na(list(expr = 0)) %>%
        arrange(expr)

    pl1 <- gene_expr %>%
        dplyr::select(gene, umap_0, umap_1, expr) %>%
        rename(x_pos = umap_0, y_pos = umap_1) %>%
        mutate(type = 'umap coordinates') %>%
        ggplot(aes(x_pos, y_pos, color = expr)) +
            geom_point(size=0.1) +
            coord_fixed() +
            facet_grid(type~gene) +
            scale_color_viridis_c(option = "inferno", direction=-1) +
            labs(color='UMI count')

    if(barcode_file){
        pl2 <- gene_expr %>%
            dplyr::select(gene, x_pos, y_pos, expr) %>%
            mutate(type = 'physical coordinates') %>%
            ggplot(aes(x_pos, y_pos, color = expr)) +
                geom_point(size=0.1) +
                coord_fixed() +
                facet_grid(type~gene) +
                scale_color_viridis_c(option = "inferno", direction=-1) +
                labs(color='UMI count')

        print(plot_grid(pl1, pl2, ncol=1))
    } else{
        print(pl1)
    }
}
```

```{r plot_clusters_umap_puck, echo =F, fig.height=fig_height, fig.width=fig_width, eval=data_complete, results='asis'}
library(ggsci)

cluster_clrs <- c('#ff8011',
                  '#2179b5',
                  '#9466be',
                  '#2b9f2b',
                  '#8c554a',
                  '#e479c3',
                  "#FF410D",
                  "#6EE2FF",
                  "#F7C530",
                  "#95CC5E",
                  "#D0DFE6",
                  "#F79D1E",
                  "#748AA6",
                  '#0DFFB7',
                  '#FFC9AD',
                  '#C4BC12',
                  '#935CFF',
                  '#FFFFFF',
                  '#E6DBCF',
                  '#99846B',
                  '#F711F7',
                  '#7AF736',
                  '#4F5EF7',
                  '#F75D1E')

top10_marker_table <- read_table2(snakemake@input$cluster_markers)

for (i in obs_df %$% res %>% unique){
    res <- as.double(strsplit(i, '_')[[1]][2])
    cat(paste0('\n\n#### ', res, ' resolution {.tabset}\n\n'))
    umap_plot <- obs_df %>%
        filter(res == i) %>%
        dplyr::select(cell_bc, umap_0, umap_1, cluster) %>%
        ggplot(aes(umap_0, umap_1, color = cluster)) +
            geom_point(size=as.numeric(snakemake@params$downstream_variables$plot_bead_size, alpha=0.9)) +
            guides(colour = guide_legend(override.aes = list(size=3)))+
            scale_color_manual(values=cluster_clrs) +
            labs(y='', x='UMAP coordinates') +
            coord_fixed() +
            theme(axis.text = element_blank(),
                  legend.position = 'none', text=element_text(size=24),
                axis.ticks = element_blank(), axis.line = element_line(color='white'))

    if (barcode_file) {
        physical_plot <- obs_df %>%
            filter(res == i) %>%
            dplyr::select(cell_bc, x_pos, y_pos, cluster) %>%
            ggplot(aes(x_pos, y_pos, color = cluster)) +
                geom_point(size=as.numeric(snakemake@params$downstream_variables$plot_bead_size, alpha=0.9)) +
                guides(colour = guide_legend(override.aes = list(size=3)))+
                scale_color_manual(values=cluster_clrs) +
                labs(y = '', x='physical coordinates') +
                coord_fixed()+
                theme(panel.background = element_rect(fill = 'gray90'), 
                  legend.position = 'none',
                    axis.ticks = element_blank(), axis.text=element_blank(), text = element_text(size =24))

        print(umap_plot)
        print(physical_plot)
    } else{
        print(umap_plot)
    }
}
```
